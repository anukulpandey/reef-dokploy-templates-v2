services:
  reef-dev-cluster:
    image: anukulpandey/reef-chain-node:linux-2
    container_name: reef-dev-cluster
    working_dir: /workspace

    environment:
      v1sec: "0x4beb11e380012110b0b072fbb3d8e7455921cf4658de06c33d970be82ccf9ed5"
      v2sec: "0x3348e15287dae612d9c8f008a468ff6c229a55c4b58d778f389cc03134e3efbe"
      v3sec: "0xba8ad5d3607f10c356860024a08ea279dbd529f0950fa752fc6c2d59981b89e5"

      v1addr: "5GH14oJ4A3VDLoC6nXutsTwS4dMwebDipNdSugD5zFnnWKp5"
      v2addr: "5CmKswtRQGFrt3CcP5waJVxgEJfRy1xsmwPLRPWkumLBz8nv"
      v3addr: "5HTmW3wtfs6h1D44QxfLPpwVzQ3Jc7S8eiQAuDRkmqEhrwMQ"

    volumes:
      - ./:/workspace

    ports:
      - "30335:30335"
      - "30333:30333"
      - "30334:30334"
      - "30336:30336"
      - "9944:9944"
      - "9945:9945"
      - "9946:9946"

    entrypoint: /bin/sh
    command: -c "
      set -e &&

      echo 'ðŸ“¦ Installing required tools...' &&
      apt-get update &&
      apt-get install -y make wget curl jq &&

      echo 'ðŸ“¥ Downloading Makefile...' &&
      wget -q -O /workspace/Makefile \
        https://raw.githubusercontent.com/anukulpandey/reef-dokploy-templates-v2/refs/heads/master/reef-cluster/Makefile &&

      echo 'ðŸ”§ Preparing fake build output...' &&
      mkdir -p target/release &&
      ln -sf /usr/local/bin/reef-node target/release/reef-node &&

      echo 'ðŸ§© Injecting ENV values into Makefile runtime...' &&
      export v1sec=$v1sec v2sec=$v2sec v3sec=$v3sec \
             v1addr=$v1addr v2addr=$v2addr v3addr=$v3addr &&

      echo 'ðŸš€ Running make run-local with environment overrides...' &&
      make run-local"
